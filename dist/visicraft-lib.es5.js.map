{"version":3,"file":"visicraft-lib.es5.js","sources":["../src/datastore/races.ts","../src/datastore/index.ts","../src/visicraft_client_options.ts","../src/visicraft_client.ts"],"sourcesContent":["import {RxCollection, RxDocument, RxJsonSchema} from \"rxdb\";\nimport {VisicraftDatastore} from \".\";\n\nexport type RaceDocumentType = {\n    identifier: string;\n\n    description: string;\n\n    summary: string;\n\n    title: string;\n};\n\nexport type RaceDocumentMethods = {};\n\nexport type RaceCollectionMethods = {};\n\nexport type RaceDocument = RxDocument<RaceDocumentType, RaceDocumentMethods>;\n\nexport type RaceCollection = RxCollection<\n    RaceDocumentType,\n    RaceDocumentMethods,\n    RaceCollectionMethods\n>;\n\nexport const RACE_COLLECTION_METHODS: RaceCollectionMethods = {};\n\nexport const RACE_DOCUMENT_METHODS: RaceDocumentMethods = {};\n\nexport const RACE_DOCUMENT_SCHEMA: RxJsonSchema<RaceDocumentType> = {\n    title: \"races\",\n    description: \"Schema for validating internally stored WCS Races\",\n    version: 0,\n\n    keyCompression: true,\n\n    required: [\"description\", \"summary\", \"title\"],\n    type: \"object\",\n\n    properties: {\n        identifier: {\n            type: \"string\",\n            primary: true\n        },\n\n        description: {type: \"string\"},\n        summary: {type: \"string\"},\n        title: {type: \"string\"}\n    }\n};\n\n/**\n * Creates the Race collection on the datastore, if not previously existed\n */\nexport function create_collection(datastore: VisicraftDatastore): Promise<void> {\n    return datastore.collection({\n        name: \"races\",\n\n        methods: RACE_DOCUMENT_METHODS,\n        schema: RACE_DOCUMENT_SCHEMA,\n        statics: RACE_COLLECTION_METHODS\n    });\n}\n","import {RxDatabase} from \"rxdb\";\n\nimport {RaceCollection, create_collection as create_races_collection} from \"./races\";\n\nexport type VisicraftCollections = {\n    races: RaceCollection;\n};\n\nexport type VisicraftDatastore = RxDatabase<VisicraftCollections>;\n\n/**\n * Creates the various collections on the datastores, if they don't already exist\n */\nexport function create_collections(datastore: VisicraftDatastore): Promise<void[]> {\n    const promise = Promise.all([create_races_collection(datastore)]);\n\n    return promise;\n}\n","import * as RxDB_namespace from \"rxdb\";\n\nimport {VisicraftDatastore, VisicraftCollections} from \"./datastore\";\n\n// HACK: Due to current Rollup not working well with packaging up RxDB,\n// `visicraft-lib` supports utilizing the browserify build that populates `window.*`\nconst RxDB = (function(): typeof RxDB_namespace {\n    if (typeof window !== \"undefined\") {\n        const _RxDB: typeof RxDB_namespace = (<any>window).RxDB;\n        if (_RxDB) return _RxDB;\n\n        throw new Error(\"bad import from 'visicraft-lib' (could not locate 'rxdb')\");\n    }\n\n    return require(\"rxdb\");\n})();\n\n// Allow `rxdb` to utilize memory as a datastore\n//const adapter: any = require(\"pouchdb-adapter-memory/lib/index.es\");\n//RxDB.plugin(adapter);\n\n/**\n * Represents the interface of options used to configured the initialized datastore\n */\nexport interface IDatastoreOptions {\n    /**\n     * Represents what type of adapter will be used for persistence, (check out plugins for RxDB)\n     */\n    adapter?: string;\n\n    /**\n     * Represents the namespace that the datastore will be persisted as\n     */\n    namespace?: string;\n}\n\n/**\n * Represents the interface of options used to configure a `VisicraftClient` instance\n */\nexport interface IVisicraftClientOptions {\n    /**\n     * Represents the options passed into configuring the datastore\n     */\n    datastore?: IDatastoreOptions;\n}\n\n/**\n * Represents the normalized options used to configure the initialized datastore\n */\nexport class DatastoreOptions implements IDatastoreOptions {\n    adapter = \"memory\";\n\n    namespace = \"visicraft_v1\";\n\n    /**\n     * Constructor for `DatastoreOptions`\n     */\n    constructor(options: IDatastoreOptions = {}) {\n        Object.assign(this, options);\n    }\n}\n\n/**\n * Represents the options used to configure a `VisicraftClient` instance\n */\nexport class VisicraftClientOptions implements IVisicraftClientOptions {\n    datastore: DatastoreOptions;\n\n    /**\n     * Constructor for `VisicraftClientOptions`\n     */\n    constructor(options: IVisicraftClientOptions = {}) {\n        this.datastore = new DatastoreOptions(options.datastore);\n    }\n\n    /**\n     * Returns the initialized datastore instance\n     */\n    create_datastore(): Promise<VisicraftDatastore> {\n        const {adapter, namespace} = this.datastore;\n\n        return RxDB.create<VisicraftCollections>({\n            adapter: adapter,\n            name: namespace,\n            queryChangeDetection: true\n        });\n    }\n}\n","import {VisicraftDatastore, create_collections} from \"./datastore\";\nimport {IVisicraftClientOptions, VisicraftClientOptions} from \"./visicraft_client_options\";\n\n/**\n * Represents the class used for base functionality of Visicraft clients\n */\nexport class VisicraftClient {\n    /**\n     * Represents the initialized datastore, if previously opened\n     */\n    datastore?: VisicraftDatastore;\n\n    /**\n     * Represents the options that `VisicraftClient` was constructed with\n     */\n    options: VisicraftClientOptions;\n\n    /**\n     * Constructor for `VisicraftClient`\n     * @param opts - Configurable options to pass in\n     */\n    constructor(opts: IVisicraftClientOptions = {}) {\n        this.options = new VisicraftClientOptions(opts);\n    }\n\n    /**\n     * Closes the connection to the current datastore\n     */\n    async close_datastore(): Promise<boolean> {\n        const datastore = this.get_datastore();\n\n        const destroyed = await datastore.destroy();\n        if (destroyed) this.datastore = undefined;\n\n        return destroyed;\n    }\n\n    /**\n     * Initializes a new connection to the configured datastore\n     */\n    async open_datastore(): Promise<VisicraftDatastore> {\n        if (this.datastore) {\n            throw new Error(\n                \"bad dispatch to 'VisicraftClient.open_datastore' (datastore already initialized)\"\n            );\n        }\n\n        const datastore = await this.options.create_datastore();\n        await create_collections(datastore);\n\n        this.datastore = datastore;\n        return datastore;\n    }\n\n    /**\n     * Returns the current datastore connection, if any, otherwise throws an exception\n     */\n    get_datastore(): VisicraftDatastore {\n        if (this.datastore) return this.datastore;\n\n        throw new Error(\"bad dispatch to 'get_datastore' (datastore not initialized)\");\n    }\n}\n"],"names":["create_races_collection"],"mappings":"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"}